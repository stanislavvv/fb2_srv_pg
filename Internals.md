# Краткое описание чего и как делается

[[__TOC__]]


## Создание списков книг (первый этап индексации)

Списки книг `.zip.list` представляют собой данные о каждом `.fb2`, находящемся в соответствующем `.zip`, по одной записи на строку.
Формат jsonl, т.е. отдельный json на строку.

Производится:

  * `./datachew.sh lists` — пересоздание всех списков с нуля
  * `./datachew.sh new_lists` — создание списков для новых/изменившихся `.zip`

Из каждого `.zip` в `data` будет извлекаться каждый `.fb2`, после чего:

  1. Получаются метаданные (ветка `FictionBook.description`), оттуда берутся поля:
    * `title-info.author` — структура, содержащая данные автора (преобразуется в строку)
    * `title-info.book-title` — название книги
    * `title-info.coverpage` — указатель на изображение-обложку (после вытаскивания изображения не используется)
    * `title-info.genre` — жанр или несколько
    * `title-info.lang` — язык
    * `title-info.sequence` — структура, определяющая серию книг и номер книги в серии
    * `title-info.annotation` — аннотация книги (сохраняется как кусок html)
    * `publish-info` — структура, где могут быть (или не быть): год издания, ISBN, наименование издательства
  2. Вытаскивается картинка, соответствующая `title-info.coverpage`, размер изменяется до 300 по ширине и преобразуется в base64
  3. Создаётся структура данных о книге, которая пишется в виде строки json в `.zip.list`, соответствующий `.zip`


## Заполнение БД

Производится:

  * `./datachew.sh fillall` — загрузка всех данных из `.zip.list` в БД с перезаписью данных для имеющихся книг
  * `./datachew.sh fillonly` — загрузка только новых книг

Каждая строка из каждого `.zip.list` проверяется на наличие в БД и либо при отсутствии просто добавляется БД, либо:

  * параметр `fillall` — делается UPDATE для соответствующих записей книги, серии, автора
  * параметр `fillonly` — книга пропускается

Параллельно собираются данные для серий книг и принадлежности авторам.

По окончании загрузки книг производится пересчёт данных о количестве книг у авторов, в сериях и в жанрах.


## opds/html интерфейс

To be written. May be.
